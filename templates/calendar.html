<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navigation Bar -->
    <div class="sidebar">
        <div class="nav-item" title="Home">
            <a href="{{ url_for('home') }}">
                <span class="icon" id="ho">üè†</span>
                <span class="label">Home</span>
            </a>
        </div>
        <div class="nav-item" title="Calendar">
            <a href="{{ url_for('calendar') }}">
                <span class="icon" id="cal">üìÖ</span>
                <span class="label">Calendar</span>
            </a>
        </div>
    </div>

    <header>
        <h1>My Calendar</h1>
        <p>Total Raised: ${{ data['total_raised'] }}</p>
</header>
<main>
    <section id="my-calendar">
        <h2>
            <span id="calendar-title">{{ cal_title }}</span>
            {% if user_signed_in == "TRUE" and token_type == "DOM" %}
                <span id="edit-icon" style="cursor: pointer;">‚úèÔ∏è</span>
                {% endif %}
            </h2>
            <form id="title-form" method="POST" style="display: none;">
                <input type="text" name="calendar_title" id="calendar-title-input" value="{{ cal_title }}">
                <button type="submit">Save</button>
            </form>
            {% if user_signed_in == "TRUE" %}
                {% if user_has_token == "TRUE" %}
                    <p>Your Token: {{ user_has_token }}</p>
                    <div id="calendar"></div>
                {% else %}
                    <div id="calendar" style="filter: blur(2px);"></div>
                    <div class="button-container">
                    <div class="dropdown">
                        <button id="grab-token-btn">Grab a Token!</button>
                    
                    </div>
                    
                    <button onclick="location.href='{{ url_for('useToken') }}'">Have a token?</button>
                </div>
                {% endif %}
            {% else %}
            
                <div id="calendar" style="filter: blur(2px);"></div>
                <div class="button-container">
                <button onclick="location.href='{{ url_for('signup') }}'">Sign Up</button>
                <button onclick="location.href='{{ url_for('login') }}'">Log In</button>
                
            </div>
            {% endif %}
            </section>
            <section>
                <h2>How It Works</h2>
                <p>Here's how the Pick-a-Date fundraiser works:</p>
                <ol>
                    <li>Select one or more dates from the calendar. Each date you pick helps us raise money.</li>
                </ol>
            </section>
        </main>

<!-- Submenu -->
<div id="dim-overlay"></div>
<div id="submenu">
    <div class="submenu-header">
        <span id="total-cost">0</span>
    </div>
    <div class="submenu-content">
        <p style="text-align: center;">How many token ya want?</p>
        <input type="number" id="token-count" value="0" min="0" style="display: block; margin: 0 auto;">
        <p style="text-align: center;">How many subtokens ya want?</p>
        <input type="number" id="subtoken-count" value="0" min="0" style="display: block; margin: 0 auto;">
        <button id="ready-to-go-btn" style="display: block; margin: 20px auto;">Ready to go?</button>
    </div>
</div>

<script src="{{ url_for('static', filename='calendar.js') }}"></script>
<!-- Submenu -->
<div id="dim-overlay"></div>
<div id="submenu">
    <div class="submenu-header">
        <span id="total-cost">0</span>
    </div>
    <div class="submenu-content">
        <p style="text-align: center;">How many token ya want?</p>
        <input type="number" id="token-count" value="0" min="0" style="display: block; margin: 0 auto;">
        <p style="text-align: center;">How many subtokens ya want?</p>
        <input type="number" id="subtoken-count" value="0" min="0" style="display: block; margin: 0 auto;">
        <button id="ready-to-go-btn" style="display: block; margin: 20px auto;">Ready to go?</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
        const grabTokenBtn = document.getElementById('grab-token-btn');
        const dimOverlay = document.getElementById('dim-overlay');
        const submenu = document.getElementById('submenu');
        const readyToGoBtn = document.getElementById('ready-to-go-btn');

        if (grabTokenBtn) {
            console.log('Grab Token button found');
            grabTokenBtn.addEventListener('click', function() {
                dimOverlay.style.display = 'block';
                submenu.style.display = 'block';
            });
        } else {
            console.error('Grab Token button not found');
        }

        const tokenCountInput = document.getElementById('token-count');
        const subtokenCountInput = document.getElementById('subtoken-count');

        if (tokenCountInput && subtokenCountInput) {
            console.log('Token and Subtoken inputs found');
            tokenCountInput.addEventListener('input', function() {
                console.log('Token count input event triggered');
                updateTotalCost();
            });
            subtokenCountInput.addEventListener('input', function() {
                console.log('Subtoken count input event triggered');
                updateTotalCost();
            });
        } else {
            console.error('Token or Subtoken input not found');
        }

        function updateTotalCost() {
            console.log('updateTotalCost called');
            const tokenCount = parseInt(tokenCountInput.value) || 0;
            const subtokenCount = parseInt(subtokenCountInput.value) || 0;
            const totalCost = (tokenCount + subtokenCount) * 10;
            const totalCostElement = document.getElementById('total-cost');
            totalCostElement.textContent = totalCost;
            totalCostElement.classList.remove('bounce');
            void totalCostElement.offsetWidth; // Trigger reflow
            totalCostElement.classList.add('bounce');
            console.log('Bounce animation triggered');
        }

        if (readyToGoBtn) {
            readyToGoBtn.addEventListener('click', function() {
                const tokenCount = parseInt(tokenCountInput.value) || 0;
                const subtokenCount = parseInt(subtokenCountInput.value) || 0;
                const totalTokens = tokenCount + subtokenCount;

                fetch('/create-payment-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `tokenGETs=${totalTokens}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        console.error('Payment link creation failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        } else {
            console.error('Ready to go button not found');
        }
    });
</script>

<style>
    #dim-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10;
    }

    #submenu {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 500px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 20;
        animation: slideDown 0.5s ease-out;
    }

    .submenu-header {
        background: #0078d4; /* Match the blue color */
        padding: 20px;
        text-align: center;
        font-size: 2rem;
        color: white;
    }

    .submenu-content {
        padding: 20px;
        text-align: center;
    }

    @keyframes slideDown {
        from {
            top: 40%;
            opacity: 0;
        }
        to {
            top: 50%;
            opacity: 1;
        }
    }

    .bounce {
        animation: bounce 0.3s;
    }

    @keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }
</style>
</body>
</html>