<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Calendar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        #customization-panel {
            display: none;
            margin: 20px auto;
            max-width: 500px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        #customization-panel.open {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        #customization-panel label {
            font-weight: bold;
            color: #0078d4;
            margin-top: 10px;
            display: block;
        }

        #customization-panel input[type="color"],
        #customization-panel input[type="file"] {
            width: 100%;
            margin: 10px 0;
            padding: 5px;
            font-size: 1rem;
        }

        #customization-panel button {
            width: 100%;
            padding: 10px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        #customization-panel button:hover {
            background-color: #005ea6;
            transform: scale(1.05);
        }

        #calendar-preview {
            padding: 20px;
            border: 2px solid #0078d4;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            background-color: #eaf2f8;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        #calendar-preview img {
            max-height: 50px;
            margin-bottom: 10px;
        }















        /* Sidebar Styles */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 60px;
        height: 100%;
        background: #2c3e50;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
        transition: width 1s ease; /* Smooth width transition */
    }

    .sidebar.expand {
        width: 100%; /* Full width expansion */
    }

    /* Overlay Background */
    .nav-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        transition: background-color 1s ease; /* Smooth background transition */
        pointer-events: none;
    }

    .nav-fullscreen.show {
        background-color: rgba(44, 62, 80, 1); /* Full color background */
        pointer-events: auto;
    }

    /* Customization Panel */
    .customization-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        opacity: 0; /* Start hidden */
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
    }
</style>

</head>
<body>
    <div class="sidebar">
        <div class="nav-item" title="Home">
            <a href="{{ url_for('home') }}">
                <span class="icon" id="ho">üè†</span>
                <span class="label">Home</span>
            </a>
        </div>
        <div class="nav-item" title="Calendar">
            <a href="{{ url_for('calendar') }}">
                <span class="icon" id="cal">üìÖ</span>
                <span class="label">Calendar</span>
            </a>
        </div>
        {% if token_type == "DOM" %}
    <div class="nav-item" title="Calendar Builder" id="builder-icon">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Calendar Builder</span>
    </div>
    {% endif %}
    </div>

    <header>
        <h1>My Calendar</h1>
        <p>Total Raised: ${{ data['total_raised'] }}</p>
    </header>









<!-- Fullscreen Customization Overlay -->
<div id="builder-overlay" class="nav-fullscreen">
    <div class="customization-panel">
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('customize_calendar') }}">
            <label for="text_color">Text Color:</label>
            <input type="color" id="text_color" name="text_color">

            <label for="border_color">Border Color:</label>
            <input type="color" id="border_color" name="border_color">

            <label for="font_style">Font Style:</label>
            <select id="font_style" name="font_style">
                <option value="Arial">Arial</option>
                <option value="Verdana">Verdana</option>
                <option value="Tahoma">Tahoma</option>
            </select>

            <label for="box_size">Date Box Size:</label>
            <input type="number" id="box_size" name="box_size" min="50" max="200">

            <label for="title_text">Calendar Title:</label>
            <input type="text" id="title_text" name="title_text">

            <label for="icon">Upload Icon:</label>
            <input type="file" id="icon" name="icon" accept="image/png">

            <button type="submit">Save Customizations</button>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const builderIcon = document.getElementById('builder-icon');
        const sidebar = document.getElementById('sidebar');
        const builderOverlay = document.getElementById('builder-overlay');
        const customizationPanel = document.querySelector('.customization-panel');

        // When the Calendar Builder icon is clicked
        if (builderIcon) {
            builderIcon.addEventListener('click', () => {
                sidebar.classList.add('expand'); // Add class to trigger CSS animation
                builderOverlay.classList.add('show'); // Show the overlay with transition
                setTimeout(() => {
                    customizationPanel.style.opacity = '1';
                    customizationPanel.style.visibility = 'visible';
                }, 1000); // Delay for sidebar animation
            });
        }

        // Close overlay when clicking outside the panel
        builderOverlay.addEventListener('click', (event) => {
            if (event.target === builderOverlay) {
                sidebar.classList.remove('expand');
                builderOverlay.classList.remove('show');
                customizationPanel.style.opacity = '0';
                customizationPanel.style.visibility = 'hidden';
            }
        });
    });
</script>


<!-- CSS -->
<style>
    /* Sidebar Styles */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 60px;
        height: 100%;
        background: #2c3e50;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
        transition: width 1s ease; /* Smooth width transition */
    }

    .sidebar.expand {
        width: 100%; /* Full width expansion */
    }

    /* Overlay Background */
    .nav-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        transition: background-color 1s ease; /* Smooth background transition */
        pointer-events: none;
    }

    .nav-fullscreen.show {
        background-color: rgba(44, 62, 80, 1); /* Full color background */
        pointer-events: auto;
    }

    /* Customization Panel */
    .customization-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        opacity: 0; /* Start hidden */
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
    }
</style>







    <main>
        <section id="my-calendar">
            <h2>
                <span id="calendar-title">{{ cal_title }}</span>
                {% if user_signed_in == "TRUE" and token_type == "DOM" %}
                    <span id="edit-icon" style="cursor: pointer;">‚úèÔ∏è</span>
                {% endif %}
            </h2>
            <form id="title-form" method="POST" style="display: none;">
                <input type="text" name="calendar_title" id="calendar-title-input" value="{{ cal_title }}">
                <button type="submit">Save</button>
            </form>
            {% if user_signed_in == "TRUE" %}
                {% if user_has_token == "TRUE" %}
                    <p>Your Token: {{ user_has_token }}</p>
                    <div id="calendar"></div>
                {% else %}
                    <div id="calendar" style="filter: blur(2px);"></div>
                    <div class="button-container">
                        <div class="dropdown">
                            <button id="grab-token-btn">Grab a Token!</button>
                        </div>
                        <div class="dropdown">
                            <button id="have-token-btn">Have a token?</button>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div id="calendar" style="filter: blur(2px);"></div>
                <div class="button-container">
                    <button onclick="location.href='{{ url_for('signup') }}'">Sign Up</button>
                    <button onclick="location.href='{{ url_for('login') }}'">Log In</button>
                </div>
            {% endif %}
        </section>
        <section>
            <h2>How It Works</h2>
            <p>Here's how the Pick-a-Date fundraiser works:</p>
            <ol>
                <li>Select one or more dates from the calendar. Each date you pick helps us raise money.</li>
            </ol>
        </section>
    </main>

    <!-- Dim overlay -->
    <div id="dim-overlay"></div>

    <!-- Submenu for grabbing a token -->
    <div id="submenu">
        <div class="submenu-header">
            <span id="total-cost">0</span>
        </div>
        <div class="submenu-content">
            <form action="/create-payment-link" method="POST">
                <p style="text-align: center;">How many tokens do you want?</p>
                <input type="number" id="token-count" name="tokens" value="0" min="0" style="display: block; margin: 0 auto;">
                <p style="text-align: center;">How many subtokens do you want?</p>
                <input type="number" id="subtoken-count" name="subtokens" value="0" min="0" style="display: block; margin: 0 auto;">
                <button id="ready-to-go-btn" style="display: block; margin: 20px auto;">Ready to go?</button>
            </form>
        </div>
    </div>

    <!-- Submenu for entering a token -->
    <div id="token-submenu" class="submenu">
        <div class="submenu-header">
            <h2>Enter your token or subtoken</h2>
        </div>
        <div class="submenu-content">
            <form id="token-form" method="POST" action="/verify-token">
                <input type="text" id="token-input" name="token" placeholder="Enter token or subtoken" required>
                <button type="submit">Verify</button>
            </form>
            <div id="token-result" style="display: none;">
                <p id="token-display"></p>
                <p id="email-display"></p>
                <button id="verify-btn" style="display: none;">So, this is what you want right?</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='calendar.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            const grabTokenBtn = document.getElementById('grab-token-btn');
            const haveTokenBtn = document.getElementById('have-token-btn');
            const dimOverlay = document.getElementById('dim-overlay');
            const submenu = document.getElementById('submenu');
            const tokenSubmenu = document.getElementById('token-submenu');
            const readyToGoBtn = document.getElementById('ready-to-go-btn');
            const tokenForm = document.getElementById('token-form');
            const tokenResult = document.getElementById('token-result');
            const tokenDisplay = document.getElementById('token-display');
            const emailDisplay = document.getElementById('email-display');
            const verifyBtn = document.getElementById('verify-btn');

            if (grabTokenBtn) {
                console.log('Grab Token button found');
                grabTokenBtn.addEventListener('click', function() {
                    dimOverlay.style.display = 'block';
                    submenu.style.display = 'block';
                });
            } else {
                console.error('Grab Token button not found');
            }

            haveTokenBtn.addEventListener('click', function () {
                dimOverlay.style.display = 'block';
                tokenSubmenu.style.display = 'block';
            });
            
            tokenForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const token = document.getElementById('token-input').value;
            
                fetch('/verify-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            tokenDisplay.textContent = `Token: ${data.token}`;
                            emailDisplay.textContent = `Email: ${data.email}`;
                            verifyBtn.style.display = 'block';
                            tokenResult.style.display = 'block';
                        } else {
                            alert('Token not found!');
                        }
                    });
            });
            
            verifyBtn.addEventListener('click', function () {
                const token = tokenDisplay.textContent.split(': ')[1];
                const email = emailDisplay.textContent.split(': ')[1];
            
                fetch('/send-verification-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, email: email })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Verification email sent to the token owner!');
                        } else {
                            alert('Failed to send verification email.');
                        }
                    });
            });
            

            function startPollingForApproval() {
                const interval = setInterval(() => {
                    fetch('/check-approval-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ token: tokenDisplay.textContent.split(': ')[1] })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.approved) {
                            clearInterval(interval);
                            document.getElementById('token-submenu').querySelector('.submenu-header h2').textContent = 'Guess what? Action approved!';
                            window.location.href = "{{ url_for('calendar') }}"
                        }
                    });
                }, 5000); // Poll every 5 seconds
            }

            const tokenCountInput = document.getElementById('token-count');
            const subtokenCountInput = document.getElementById('subtoken-count');

            if (tokenCountInput && subtokenCountInput) {
                console.log('Token and Subtoken inputs found');
                tokenCountInput.addEventListener('input', function() {
                    console.log('Token count input event triggered');
                    updateTotalCost();
                });
                subtokenCountInput.addEventListener('input', function() {
                    console.log('Subtoken count input event triggered');
                    updateTotalCost();
                });
            } else {
                console.error('Token or Subtoken input not found');
            }

            function updateTotalCost() {
                console.log('updateTotalCost called');
                const tokenCount = parseInt(tokenCountInput.value) || 0;
                const subtokenCount = parseInt(subtokenCountInput.value) || 0;
                const totalCost = ((tokenCount * 10) + (subtokenCount * 5));
                const totalCostElement = document.getElementById('total-cost');
                totalCostElement.textContent = totalCost;
                totalCostElement.classList.remove('bounce');
                void totalCostElement.offsetWidth; // Trigger reflow
                totalCostElement.classList.add('bounce');
                console.log('Bounce animation triggered');
            }

            if (readyToGoBtn) {
                readyToGoBtn.addEventListener('click', function() {
                    const tokenCount = parseInt(tokenCountInput.value) || 0;
                    const subtokenCount = parseInt(subtokenCountInput.value) || 0;
                    const totalTokens = tokenCount + subtokenCount;

                    fetch('/create-payment-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `tokenGETs=${totalTokens}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.url) {
                            window.location.href = data.url;
                        } else {
                            console.error('Payment link creation failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            } else {
                console.error('Ready to go button not found');
            }
        });











        document.addEventListener('DOMContentLoaded', function() {
            const editIcon = document.getElementById('edit-icon');
            const customizationPanel = document.getElementById('customization-panel');
            
            if (editIcon) {
                editIcon.addEventListener('click', () => {
                    customizationPanel.style.display = customizationPanel.style.display === 'none' ? 'block' : 'none';
                });
            }
        });









        document.addEventListener('DOMContentLoaded', () => {
            const builderIcon = document.getElementById('builder-icon');
            const builderOverlay = document.getElementById('builder-overlay');
    
            if (builderIcon) {
                builderIcon.addEventListener('click', () => {
                    builderOverlay.style.display = 'flex';
                });
            }
        });
    </script>

    <style>
        #dim-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        #submenu, #token-submenu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 20;
            animation: slideDown 0.5s ease-out;
        }

        .submenu-header {
            background: #0078d4; /* Match the blue color */
            padding: 20px;
            text-align: center;
            font-size: 2rem;
            color: white;
        }

        .submenu-content {
            padding: 20px;
            text-align: center;
        }

        @keyframes slideDown {
            from {
                top: 40%;
                opacity: 0;
            }
            to {
                top: 50%;
                opacity: 1;
            }
        }

        .bounce {
            animation: bounce 0.3s;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }


        


            
    </style>
</body>
</html>